{% extends "base.html" %}

{% block title %}{% if edit_mode %}Edit Schedule - Step 4{% else %}Set Destinations - Step 4{% endif %}{% endblock %}

{% block content %}
<!-- Edit mode variables -->
{% set edit_mode = edit_mode or false %}
{% set edit_schedule_id = edit_schedule_id or '' %}
{% set preloaded_destinations = preloaded_destinations or [] %}
{% set preloaded_schedule_name = preloaded_schedule_name or '' %}

<div class="mobile-app-container">
  <div class="page-header">
    <div class="header-content">
      <h4 class="page-title"><i class="fas fa-{% if edit_mode %}edit{% else %}map-marker-alt{% endif %} me-2"></i>{% if edit_mode %}Edit Schedule{% else %}Set Destinations{% endif %}</h4>
      <p class="page-subtitle">{% if edit_mode %}Step 4 of 5 • Update destinations{% else %}Step 4 of 4 • Configure route and timing{% endif %}</p>
    </div>
    <a href="{% if edit_mode %}{{ url_for('scheduling.block_seats') }}{% else %}{{ url_for('scheduling.block_seats') }}{% endif %}" class="add-btn" title="Back"><i class="fas fa-arrow-left"></i></a>
  </div>

  <div class="form-card">
    <form id="destinationsForm">
                        <div class="mb-4">
                            <label for="scheduleName" class="form-label fw-bold">
                                <i class="fas fa-tag me-2"></i>Schedule Name
                            </label>
                            <input type="text" class="form-control" id="scheduleName" name="schedule_name" 
                                   value="{{ preloaded_schedule_name }}" placeholder="e.g., Male to Maafushi Trip">
                            <div class="form-text">Leave blank to auto-generate from destinations</div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-route me-2"></i>Destinations
                                </h5>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addDestination()">
                                    <i class="fas fa-plus me-1"></i>Add Destination
                                </button>
                            </div>
                            
                            <div id="destinationsList">
                                <!-- Destinations will be added here -->
                            </div>
                        </div>
                        
      <div class="actions">
        <a href="{% if edit_mode %}{{ url_for('scheduling.block_seats') }}{% else %}{{ url_for('scheduling.block_seats') }}{% endif %}" class="cancel-link"><i class="fas fa-arrow-left me-2"></i>{% if edit_mode %}Back to seats{% else %}Back to seats{% endif %}</a>
        <button type="submit" class="submit-btn"><i class="fas fa-check me-2"></i>{% if edit_mode %}Continue to schedule options{% else %}Create schedule{% endif %}</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  .mobile-app-container { max-width: 800px; margin: 0 auto; padding: 1rem; }
  .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; padding: 1rem; background: #fff; border: 1px solid #e9ecef; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .header-content { flex: 1; }
  .page-title { margin: 0; font-size: 1.125rem; font-weight: 600; color: #212529; }
  .page-subtitle { margin: 0.25rem 0 0; color: #6c757d; font-size: 0.85rem; }
  .add-btn { width: 40px; height: 40px; background: #f1f3f5; color: #495057; display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; text-decoration: none; }
  .form-card { background: #fff; border: 1px solid #e9ecef; border-radius: 16px; padding: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

.autocomplete-dropdown {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    width: 100%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.autocomplete-item {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
}

.autocomplete-item:hover {
    background-color: #f8f9fa;
}

.autocomplete-item.selected {
    background-color: #007bff;
    color: white;
}

.island-input-container {
    position: relative;
}
</style>

<script>
let destinations = [];
let destinationCounter = 0;
let searchTimeout = null;

// Auto-fill suggestions
const recentNames = {{ recent_names|tojson }};

document.addEventListener('DOMContentLoaded', function() {
    // Check if we're in edit mode and preload data
    const editMode = {{ edit_mode|tojson }};
    const preloadedDestinations = {{ preloaded_destinations|tojson }};
    const preloadedScheduleName = {{ preloaded_schedule_name|tojson }};
    
    if (editMode && preloadedDestinations && preloadedDestinations.length > 0) {
        // Preload destinations
        destinations = preloadedDestinations;
        destinationCounter = preloadedDestinations.length;
        
        // Render preloaded destinations
        preloadedDestinations.forEach((dest, index) => {
            addDestination(dest.island_name, dest.departure_time, dest.arrival_time, dest.is_pickup, dest.is_dropoff);
        });
    } else {
        addDestination(); // Add first destination by default
    }
    
    // Auto-fill schedule name if recent names exist or if editing
    if (editMode && preloadedScheduleName) {
        const nameInput = document.getElementById('scheduleName');
        nameInput.value = preloadedScheduleName;
    } else if (recentNames && recentNames.length > 0) {
        const nameInput = document.getElementById('scheduleName');
        nameInput.placeholder = `e.g., ${recentNames[0]}`;
    }
    
    // Initialize auto-complete for existing inputs
    initializeAutoComplete();
});

// Auto-complete functionality
function initializeAutoComplete() {
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('island-input')) {
            handleIslandInput(e.target);
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('island-input') && !e.target.closest('.autocomplete-dropdown')) {
            hideAutoComplete();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.target.classList.contains('island-input')) {
            handleIslandKeydown(e);
        }
    });
}

function handleIslandInput(input) {
    const query = input.value.trim();
    
    if (query.length < 2) {
        hideAutoComplete();
        return;
    }
    
    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Debounce search
    searchTimeout = setTimeout(() => {
        searchIslands(query, input);
    }, 300);
}

function searchIslands(query, input) {
    fetch(`/schedules/api/islands/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            showAutoComplete(data, input);
        })
        .catch(error => {
            console.error('Error searching islands:', error);
        });
}

function showAutoComplete(results, input) {
    const container = input.closest('.island-input-container');
    const dropdown = container.querySelector('.autocomplete-dropdown');
    
    if (results.length === 0) {
        hideAutoComplete(input);
        return;
    }
    
    // Populate dropdown
    dropdown.innerHTML = results.slice(0, 5).map((island, index) => `
        <div class="autocomplete-item" data-index="${index}" data-value="${island.name}">
            <strong>${island.name}</strong>
            ${island.alt_name ? `<br><small class="text-muted">${island.alt_name}</small>` : ''}
        </div>
    `).join('');
    
    dropdown.style.display = 'block';
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
            input.value = this.dataset.value;
            hideAutoComplete(input);
        });
    });
}

function hideAutoComplete(input) {
    const container = input ? input.closest('.island-input-container') : null;
    if (container) {
        const dropdown = container.querySelector('.autocomplete-dropdown');
        dropdown.style.display = 'none';
        dropdown.innerHTML = '';
    } else {
        // Hide all dropdowns if no specific input provided
        document.querySelectorAll('.autocomplete-dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
            dropdown.innerHTML = '';
        });
    }
}

function handleIslandKeydown(e) {
    const container = e.target.closest('.island-input-container');
    const dropdown = container.querySelector('.autocomplete-dropdown');
    const items = dropdown.querySelectorAll('.autocomplete-item');
    const selectedItem = dropdown.querySelector('.autocomplete-item.selected');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (selectedItem) {
            selectedItem.classList.remove('selected');
            const nextItem = selectedItem.nextElementSibling;
            if (nextItem) {
                nextItem.classList.add('selected');
            } else {
                items[0].classList.add('selected');
            }
        } else if (items.length > 0) {
            items[0].classList.add('selected');
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (selectedItem) {
            selectedItem.classList.remove('selected');
            const prevItem = selectedItem.previousElementSibling;
            if (prevItem) {
                prevItem.classList.add('selected');
            } else {
                items[items.length - 1].classList.add('selected');
            }
        } else if (items.length > 0) {
            items[items.length - 1].classList.add('selected');
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedItem) {
            e.target.value = selectedItem.dataset.value;
            hideAutoComplete(e.target);
        }
    } else if (e.key === 'Escape') {
        hideAutoComplete(e.target);
    }
}

function addDestination(islandName = '', departureTime = '', arrivalTime = '', isPickup = true, isDropoff = true) {
    destinationCounter++;
    const destinationId = `dest_${destinationCounter}`;
    
    const destinationHtml = `
        <div class="destination-item card mb-3" id="${destinationId}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-map-marker-alt text-primary me-2"></i>Destination ${destinationCounter}
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDestination('${destinationId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Island Name</label>
                        <div class="island-input-container">
                            <input type="text" class="form-control island-input" name="island_name" 
                                   value="${islandName}" placeholder="Enter island name" required autocomplete="off">
                            <div class="autocomplete-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Departure Time</label>
                        <div class="input-group">
                            <input type="time" class="form-control" name="departure_time" value="${departureTime}" placeholder="Optional">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearTime(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Arrival Time</label>
                        <div class="input-group">
                            <input type="time" class="form-control" name="arrival_time" value="${arrivalTime}" placeholder="Optional">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearTime(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_pickup" value="true" ${isPickup ? 'checked' : ''}>
                            <label class="form-check-label">Pickup Point</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_dropoff" value="true" ${isDropoff ? 'checked' : ''}>
                            <label class="form-check-label">Dropoff Point</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('destinationsList').insertAdjacentHTML('beforeend', destinationHtml);
}

function removeDestination(destinationId) {
    const element = document.getElementById(destinationId);
    if (element) {
        element.remove();
        updateDestinationNumbers();
    }
}

function updateDestinationNumbers() {
    const destinationItems = document.querySelectorAll('.destination-item');
    destinationItems.forEach((item, index) => {
        const title = item.querySelector('.card-title');
        title.innerHTML = `<i class="fas fa-map-marker-alt text-primary me-2"></i>Destination ${index + 1}`;
    });
}

function clearTime(button) {
    const timeInput = button.parentElement.querySelector('input[type="time"]');
    timeInput.value = '';
}

document.getElementById('destinationsForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Collect destinations data
    const destinations = [];
    const destinationItems = document.querySelectorAll('.destination-item');
    
    destinationItems.forEach((item, index) => {
        const islandName = item.querySelector('input[name="island_name"]').value;
        const departureTime = item.querySelector('input[name="departure_time"]').value;
        const arrivalTime = item.querySelector('input[name="arrival_time"]').value;
        const isPickup = item.querySelector('input[name="is_pickup"]').checked;
        const isDropoff = item.querySelector('input[name="is_dropoff"]').checked;
        
        if (islandName) {
            destinations.push({
                island_name: islandName,
                departure_time: departureTime || null,
                arrival_time: arrivalTime || null,
                is_pickup: isPickup,
                is_dropoff: isDropoff
            });
        }
    });
    
    const scheduleName = document.getElementById('scheduleName').value.trim();
    const button = document.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    
    if (destinations.length === 0) {
        showAlert('Please add at least one destination', 'warning');
        return;
    }
    
    showLoading(button);
    
    try {
        const response = await fetch('/schedules/set-destinations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                destinations: destinations,
                schedule_name: scheduleName
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(data.message, 'success');
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to create schedule', 'danger');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'danger');
    } finally {
        hideLoading(button, originalText);
    }
});
</script>

<style>
.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    width: 100%;
    height: 2px;
    background-color: #e9ecef;
    z-index: -1;
}

.step.completed .step-number {
    background-color: var(--success-color);
    color: white;
}

.step.completed::after {
    background-color: var(--success-color);
}

.step.active .step-number {
    background-color: var(--primary-color);
    color: white;
}

.step.active::after {
    background-color: var(--primary-color);
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
    text-align: center;
    font-weight: 500;
}

.step.active .step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.step.completed .step-label {
    color: var(--success-color);
    font-weight: 600;
}

.destination-item {
    border: 1px solid #e9ecef;
    transition: all 0.2s ease;
}

.destination-item:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.actions { display: flex; justify-content: space-between; gap: 0.75rem; margin-top: 1rem; }
.submit-btn { border: none; border-radius: 12px; padding: 0.6rem 0.9rem; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; font-weight: 600; }
.cancel-link { align-self: center; color: #6c757d; text-decoration: none; }
.cancel-link:hover { text-decoration: underline; }
</style>
{% endblock %} 