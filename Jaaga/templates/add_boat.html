{% extends "base.html" %}

{% block title %}Add New Boat - Nashath Booking{% endblock %}

{% block content %}
<!-- Mobile App Style Add Boat Page -->
<div class="mobile-app-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </div>
      <div class="header-info">
        <h4 class="page-title">Add New Boat</h4>
        <p class="page-subtitle">Register a new boat to your fleet</p>
      </div>
    </div>
  </div>

  <!-- Form Container -->
  <div class="form-container">
    <form id="addBoatForm">
                    <form id="addBoatForm">
      <!-- Basic Information -->
      <div class="form-section">
        <h5 class="section-title">Basic Information</h5>
        
        <div class="form-group">
          <label for="name" class="form-label">Boat Name *</label>
          <input type="text" class="form-input" id="name" name="name" 
                 placeholder="e.g., Speed Boat 1, Ocean Express" required>
        </div>
        
        <div class="form-group">
          <label for="seating_type" class="form-label">Seating Configuration *</label>
          <select class="form-select" id="seating_type" name="seating_type" required>
            <option value="">Select seating type</option>
            <option value="total">Total Seat Count (Simple)</option>
            <option value="chart">Seat Chart (Advanced)</option>
          </select>
          <div class="form-help">
            <strong>Total Seat Count:</strong> Simple numbering (1, 2, 3, etc.)<br>
            <strong>Seat Chart:</strong> Custom seat layout (A1, A2, B1, B2, etc.)
          </div>
        </div>
        
        <div class="form-group" id="totalSeatsSection" style="display: none;">
          <label for="total_seats" class="form-label">Total Number of Seats *</label>
          <input type="number" class="form-input" id="total_seats" name="total_seats" 
                 min="1" max="100" placeholder="e.g., 20">
        </div>
      </div>
                        
      <!-- Seat Chart Configuration -->
      <div class="form-section" id="seatChartSection" style="display: none;">
        <h5 class="section-title">Seat Chart Configuration</h5>
        
        <div class="info-card">
          <div class="info-icon">
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="info-content">
            <strong>Grid-Based Seat Chart:</strong> Create a grid and click boxes to mark them as walkways. Remaining boxes become seats.
          </div>
        </div>
        
        <div id="seatChartBuilder">
          <div class="grid-config">
            <div class="config-row">
              <div class="config-item">
                <label for="rows" class="form-label">Number of Rows</label>
                <input type="number" class="form-input" id="rows" min="1" value="4">
              </div>
              <div class="config-item">
                <label for="seatsPerRow" class="form-label">Number of Columns</label>
                <input type="number" class="form-input" id="seatsPerRow" min="1" value="5">
              </div>
            </div>
            
            <div class="form-group">
              <label for="seatLabelType" class="form-label">Seat Label Type</label>
              <select class="form-select" id="seatLabelType">
                <option value="auto">Auto (A1, A2, B1, B2...)</option>
                <option value="custom">Custom Labels</option>
              </select>
            </div>
            
            <button type="button" class="action-btn primary" onclick="generateGrid()">
              <i class="fas fa-th me-2"></i>Generate Grid
            </button>
          </div>
          
          <div id="gridPreview" style="display: none;">
            <div class="preview-header">
              <h6>Grid Configuration</h6>
              <div class="info-badge">
                <i class="fas fa-mouse-pointer me-1"></i>
                Interactive Grid
              </div>
            </div>
            <div class="info-card">
              <div class="info-icon">
                <i class="fas fa-lightbulb"></i>
              </div>
              <div class="info-content">
                Click boxes to toggle between seats and walkways. Click on seats to edit labels or change status.
              </div>
            </div>
            <div id="gridDisplay" class="grid-display"></div>
            <div class="action-buttons">
              <button type="button" class="action-btn secondary" onclick="resetGrid()">
                <i class="fas fa-undo me-1"></i>Reset Grid
              </button>
              <button type="button" class="action-btn success" onclick="finalizeSeatChart()">
                <i class="fas fa-check me-1"></i>Finalize Seat Chart
              </button>
            </div>
          </div>
          
          <div id="seatChartPreview" style="display: none;">
            <div class="preview-header">
              <h6>Final Seat Chart</h6>
              <div class="info-badge">
                <i class="fas fa-check-circle me-1"></i>
                Ready
              </div>
            </div>
            <div class="info-card">
              <div class="info-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="info-content">
                This is how your boat seating will appear to passengers (walkways hidden).
              </div>
            </div>
            <div id="seatChartDisplay" class="seat-chart-display"></div>
            <div class="action-buttons">
              <button type="button" class="action-btn secondary" onclick="backToGrid()">
                <i class="fas fa-arrow-left me-1"></i>Back to Grid
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="submit-btn" id="submitBtn">
          <i class="fas fa-save me-2"></i>Add Boat
        </button>
        <a href="{{ url_for('boat_management.boats') }}" class="cancel-btn">
          <i class="fas fa-arrow-left me-2"></i>Back to Boats
        </a>
      </div>
    </form>
  </div>
</div>
<style>
  .mobile-app-container {
    max-width: 600px;
    margin: 0 auto;
    padding: 1rem;
  }

  .page-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
  }

  .header-content {
    display: flex;
    align-items: center;
    flex: 1;
  }

  .back-btn {
    width: 40px;
    height: 40px;
    background: #f8f9fa;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .back-btn:hover {
    background: #e9ecef;
  }

  .header-info {
    flex: 1;
  }

  .page-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #212529;
  }

  .page-subtitle {
    margin: 0.25rem 0 0 0;
    font-size: 0.875rem;
    color: #6c757d;
  }

  .form-container {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
  }

  .form-section {
    margin-bottom: 2rem;
  }

  .section-title {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1.125rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .form-input, .form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    font-size: 0.875rem;
    transition: border-color 0.2s ease;
    background: #f8f9fa;
  }

  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: #667eea;
    background: white;
  }

  .form-help {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    color: #6c757d;
    line-height: 1.4;
  }

  .info-card {
    background: #e7f3ff;
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    align-items: flex-start;
    margin-bottom: 1rem;
  }

  .info-icon {
    color: #0d6efd;
    margin-right: 0.75rem;
    margin-top: 0.125rem;
  }

  .info-content {
    font-size: 0.875rem;
    color: #0d6efd;
    line-height: 1.4;
  }

  .grid-config {
    margin-bottom: 1.5rem;
  }

  .config-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .config-item {
    flex: 1;
  }

  .action-btn {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    border: none;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .action-btn.primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
  }

  .action-btn.primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .action-btn.secondary {
    background: #f8f9fa;
    color: #6c757d;
  }

  .action-btn.secondary:hover {
    background: #e9ecef;
    color: #495057;
  }

  .action-btn.success {
    background: #d1e7dd;
    color: #0f5132;
  }

  .action-btn.success:hover {
    background: #badbcc;
  }

  .preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .preview-header h6 {
    margin: 0;
    font-weight: 600;
    color: #495057;
  }

  .info-badge {
    background: #fff3cd;
    color: #856404;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .grid-display, .seat-chart-display {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #e9ecef;
  }

  .action-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .form-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }

  .submit-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 1rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .submit-btn:hover {
    transform: translateY(-2px);
  }

  .cancel-btn {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    text-decoration: none;
    font-size: 1rem;
    font-weight: 500;
    transition: background 0.2s ease;
  }

  .cancel-btn:hover {
    background: #e9ecef;
    color: #495057;
    text-decoration: none;
  }

  /* Grid and Seat Chart Styles */
  .grid-display .d-flex, .seat-chart-display .d-flex {
    gap: 0.25rem;
    margin-bottom: 0.5rem;
  }

  .grid-box, .seat-preview {
    min-width: 35px !important;
    min-height: 35px !important;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 6px;
  }

  @media (min-width: 768px) {
    .mobile-app-container {
      max-width: 800px;
    }
    
    .config-row {
      grid-template-columns: 1fr 1fr;
    }
    
    .form-actions {
      flex-direction: row;
    }
    
    .submit-btn, .cancel-btn {
      flex: 1;
    }
  }

  @media (max-width: 480px) {
    .config-row {
      grid-template-columns: 1fr;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .grid-box, .seat-preview {
      min-width: 30px !important;
      min-height: 30px !important;
      font-size: 0.7rem;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
let gridData = [];
let seatChartData = [];
let isGridMode = true;

document.getElementById('seating_type').addEventListener('change', function() {
    const seatingType = this.value;
    const totalSeatsSection = document.getElementById('totalSeatsSection');
    const seatChartSection = document.getElementById('seatChartSection');
    
    if (seatingType === 'total') {
        totalSeatsSection.style.display = 'block';
        seatChartSection.style.display = 'none';
    } else if (seatingType === 'chart') {
        totalSeatsSection.style.display = 'none';
        seatChartSection.style.display = 'block';
    } else {
        totalSeatsSection.style.display = 'none';
        seatChartSection.style.display = 'none';
    }
});

            function generateGrid() {
                const rows = parseInt(document.getElementById('rows').value);
                const cols = parseInt(document.getElementById('seatsPerRow').value);
                
                if (rows < 1 || cols < 1) {
                    showAlert('Please enter valid numbers for rows and columns (minimum 1)', 'danger');
                    return;
                }
                
                if (rows > 50 || cols > 50) {
                    showAlert('Please enter reasonable numbers for rows and columns (maximum 50 each)', 'danger');
                    return;
                }
    
    gridData = [];
    const display = document.getElementById('gridDisplay');
    display.innerHTML = '';
    
    for (let row = 0; row < rows; row++) {
        const rowData = [];
        const rowDiv = document.createElement('div');
        rowDiv.className = 'd-flex justify-content-center mb-2';
        
        for (let col = 0; col < cols; col++) {
            const isWalkway = false; // Default to seat
            rowData.push({ 
                isWalkway: isWalkway,
                row: row,
                col: col
            });
            
            const boxDiv = document.createElement('div');
            boxDiv.className = 'grid-box mx-1 p-2 border rounded bg-white text-center cursor-pointer';
            boxDiv.style.minWidth = '40px';
            boxDiv.style.minHeight = '40px';
            boxDiv.style.cursor = 'pointer';
            boxDiv.style.display = 'flex';
            boxDiv.style.alignItems = 'center';
            boxDiv.style.justifyContent = 'center';
            boxDiv.textContent = 'S'; // S for Seat
            boxDiv.onclick = () => toggleBox(row, col);
            boxDiv.setAttribute('data-row', row);
            boxDiv.setAttribute('data-col', col);
            rowDiv.appendChild(boxDiv);
        }
        
        gridData.push(rowData);
        display.appendChild(rowDiv);
    }
    
    document.getElementById('gridPreview').style.display = 'block';
    document.getElementById('seatChartPreview').style.display = 'none';
    isGridMode = true;
}

function toggleBox(row, col) {
    const box = gridData[row][col];
    
    if (box.isWalkway) {
        // Converting walkway to seat - show seat configuration popup
        box.isWalkway = false;
        configureSeat(row, col);
    } else {
        // Converting seat to walkway
        box.isWalkway = true;
        
        const boxElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (boxElement) {
            boxElement.textContent = 'W';
            boxElement.className = 'grid-box mx-1 p-2 border rounded bg-warning text-center cursor-pointer';
            boxElement.style.minWidth = '40px';
            boxElement.style.minHeight = '40px';
            boxElement.style.cursor = 'pointer';
            boxElement.style.display = 'flex';
            boxElement.style.alignItems = 'center';
            boxElement.style.justifyContent = 'center';
        }
    }
}

function configureSeat(row, col) {
    const seatLabelType = document.getElementById('seatLabelType').value;
    let seatNumber;
    
    if (seatLabelType === 'auto') {
        seatNumber = String.fromCharCode(65 + row) + (col + 1); // A1, A2, B1, B2, etc.
    } else {
        seatNumber = prompt(`Enter label for seat at row ${row + 1}, column ${col + 1}:`, `${row + 1}${col + 1}`);
        if (!seatNumber) seatNumber = `${row + 1}${col + 1}`;
    }
    
    // Update the grid display
    const boxElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
    if (boxElement) {
        boxElement.textContent = seatNumber;
        boxElement.className = 'grid-box mx-1 p-2 border rounded bg-success text-white text-center cursor-pointer';
        boxElement.style.minWidth = '40px';
        boxElement.style.minHeight = '40px';
        boxElement.style.cursor = 'pointer';
        boxElement.style.display = 'flex';
        boxElement.style.alignItems = 'center';
        boxElement.style.justifyContent = 'center';
        boxElement.onclick = () => editSeatInGrid(row, col, seatNumber);
    }
    
    // Store seat data
    gridData[row][col].seatNumber = seatNumber;
    gridData[row][col].available = true;
    gridData[row][col].status = 'available';
}

function editSeatInGrid(row, col, currentLabel) {
    const action = prompt('Choose action:\n1. Edit label\n2. Mark as damaged\n3. Mark as available\n4. Convert to walkway\n\nEnter 1, 2, 3, or 4:');
    
    if (action === '1') {
        const newLabel = prompt('Enter new seat label:', currentLabel);
        if (newLabel && newLabel.trim()) {
            gridData[row][col].seatNumber = newLabel.trim();
            
            const boxElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (boxElement) {
                boxElement.textContent = newLabel.trim();
                // Update the onclick function to use the new label
                boxElement.onclick = () => editSeatInGrid(row, col, newLabel.trim());
            }
        }
    } else if (action === '2') {
        // Mark as damaged
        gridData[row][col].available = false;
        gridData[row][col].status = 'damaged';
        
        const boxElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (boxElement) {
            boxElement.className = 'grid-box mx-1 p-2 border rounded bg-danger text-white text-center cursor-pointer';
            boxElement.style.minWidth = '40px';
            boxElement.style.minHeight = '40px';
            boxElement.style.cursor = 'pointer';
            boxElement.style.display = 'flex';
            boxElement.style.alignItems = 'center';
            boxElement.style.justifyContent = 'center';
        }
    } else if (action === '3') {
        // Mark as available
        gridData[row][col].available = true;
        gridData[row][col].status = 'available';
        
        const boxElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (boxElement) {
            boxElement.className = 'grid-box mx-1 p-2 border rounded bg-success text-white text-center cursor-pointer';
            boxElement.style.minWidth = '40px';
            boxElement.style.minHeight = '40px';
            boxElement.style.cursor = 'pointer';
            boxElement.style.display = 'flex';
            boxElement.style.alignItems = 'center';
            boxElement.style.justifyContent = 'center';
        }
    } else if (action === '4') {
        // Convert to walkway
        gridData[row][col].isWalkway = true;
        delete gridData[row][col].seatNumber;
        delete gridData[row][col].available;
        delete gridData[row][col].status;
        
        const boxElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
        if (boxElement) {
            boxElement.textContent = 'W';
            boxElement.className = 'grid-box mx-1 p-2 border rounded bg-warning text-center cursor-pointer';
            boxElement.style.minWidth = '40px';
            boxElement.style.minHeight = '40px';
            boxElement.style.cursor = 'pointer';
            boxElement.style.display = 'flex';
            boxElement.style.alignItems = 'center';
            boxElement.style.justifyContent = 'center';
            boxElement.onclick = () => toggleBox(row, col);
        }
    }
}

function resetGrid() {
    if (confirm('Are you sure you want to reset the grid? This will clear all walkway selections.')) {
        generateGrid();
    }
}

function finalizeSeatChart() {
    const seatLabelType = document.getElementById('seatLabelType').value;
    seatChartData = [];
    let seatCount = 0;
    
    // Count total seats (non-walkway boxes)
    for (let row = 0; row < gridData.length; row++) {
        for (let col = 0; col < gridData[row].length; col++) {
            if (!gridData[row][col].isWalkway) {
                seatCount++;
            }
        }
    }
    
    if (seatCount === 0) {
        showAlert('Please select at least one seat (non-walkway box)', 'danger');
        return;
    }
    
    const display = document.getElementById('seatChartDisplay');
    display.innerHTML = '';
    
    for (let row = 0; row < gridData.length; row++) {
        const rowData = [];
        const rowDiv = document.createElement('div');
        rowDiv.className = 'd-flex justify-content-center mb-2';
        
        for (let col = 0; col < gridData[row].length; col++) {
            const box = gridData[row][col];
            
            if (!box.isWalkway) {
                // This is a seat - use stored data from grid
                let seatNumber = box.seatNumber || String.fromCharCode(65 + row) + (col + 1);
                let seatStatus = box.status || 'available';
                let seatAvailable = box.available !== undefined ? box.available : true;
                
                rowData.push({ 
                    number: seatNumber, 
                    available: seatAvailable,
                    status: seatStatus,
                    row: row,
                    col: col,
                    isWalkway: false
                });
                
                const seatDiv = document.createElement('div');
                // Set color based on seat status
                let seatClass = 'seat-preview mx-1 p-2 border rounded text-white text-center';
                if (seatStatus === 'damaged') {
                    seatClass += ' bg-danger';
                } else {
                    seatClass += ' bg-success';
                }
                seatDiv.className = seatClass;
                seatDiv.style.minWidth = '40px';
                seatDiv.style.minHeight = '40px';
                seatDiv.style.display = 'flex';
                seatDiv.style.alignItems = 'center';
                seatDiv.style.justifyContent = 'center';
                seatDiv.textContent = seatNumber;
                rowDiv.appendChild(seatDiv);
            } else {
                // This is a walkway - add empty space
                const walkwayDiv = document.createElement('div');
                walkwayDiv.className = 'mx-1';
                walkwayDiv.style.minWidth = '40px';
                walkwayDiv.style.minHeight = '40px';
                walkwayDiv.style.display = 'flex';
                walkwayDiv.style.alignItems = 'center';
                walkwayDiv.style.justifyContent = 'center';
                walkwayDiv.innerHTML = '<span class="text-muted">Â·</span>';
                rowDiv.appendChild(walkwayDiv);
            }
        }
        
        if (rowData.length > 0) {
            seatChartData.push(rowData);
        }
        display.appendChild(rowDiv);
    }
    
    document.getElementById('gridPreview').style.display = 'none';
    document.getElementById('seatChartPreview').style.display = 'block';
    isGridMode = false;
    
    // Update total seats count
    document.getElementById('total_seats').value = seatCount;
}

function backToGrid() {
    document.getElementById('gridPreview').style.display = 'block';
    document.getElementById('seatChartPreview').style.display = 'none';
    isGridMode = true;
}

document.getElementById('addBoatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const seatingType = document.getElementById('seating_type').value;
    const formData = {
        name: document.getElementById('name').value.trim(),
        seating_type: seatingType,
        total_seats: parseInt(document.getElementById('total_seats').value),
        seating_chart: null
    };
    
    // For seat chart, include both grid data and final seat chart
    if (seatingType === 'chart') {
        formData.seating_chart = JSON.stringify({
            gridData: gridData,
            seatChartData: seatChartData,
            isGridMode: isGridMode
        });
    }
    
    const button = document.getElementById('submitBtn');
    const originalText = button.innerHTML;
    
    // Validation
    if (!formData.name) {
        showAlert('Please enter a boat name', 'danger');
        return;
    }
    
    if (!formData.seating_type) {
        showAlert('Please select a seating type', 'danger');
        return;
    }
    
    if (!formData.total_seats || formData.total_seats < 1) {
        showAlert('Please enter a valid number of seats', 'danger');
        return;
    }
    
    if (seatingType === 'chart' && (!seatChartData || seatChartData.length === 0)) {
        showAlert('Please finalize the seat chart first', 'danger');
        return;
    }
    
    showLoading(button);
    
    try {
        const response = await fetch('/boats/boats/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(data.message, 'success');
            setTimeout(() => {
                window.location.href = data.redirect;
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to add boat', 'danger');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'danger');
    } finally {
        hideLoading(button, originalText);
    }
});
</script>
{% endblock %} 