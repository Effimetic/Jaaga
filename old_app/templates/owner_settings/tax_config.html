{% extends "base.html" %}

{% block title %}Tax Profiles - Settings{% endblock %}

{% block content %}
<!-- Mobile App Style Tax Profiles Page -->
<div class="mobile-app-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="back-btn" onclick="history.back()">
        <i class="fas fa-arrow-left"></i>
      </div>
      <div class="header-info">
        <h4 class="page-title">Tax Profiles</h4>
        <p class="page-subtitle">Manage tax calculation profiles</p>
      </div>
    </div>
  </div>

  <!-- Tax Profiles List -->
  <div class="profiles-container">
    <div class="section-header">
      <h6 class="section-title">Your Tax Profiles</h6>
      <button type="button" class="add-btn" onclick="showCreateProfileModal()">
        <i class="fas fa-plus me-2"></i>New Profile
      </button>
    </div>
    
    <div id="taxProfilesList">
      {% if tax_profiles %}
        {% for profile in tax_profiles %}
        <div class="profile-card" data-profile-id="{{ profile.id }}">
          <div class="profile-header">
            <h6 class="profile-name">{{ profile.name }}</h6>
            <div class="profile-actions">
              <button type="button" class="edit-btn" onclick="editProfile({{ profile.id }})" title="Edit profile">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="delete-btn" onclick="deleteProfile({{ profile.id }})" title="Delete profile">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="profile-details">
            <div class="detail-item">
              <span class="label">Rounding Rule:</span>
              <span class="value">{{ profile.rounding_rule.replace('_', ' ').title() }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Tax Lines:</span>
              <span class="value">{{ profile.lines|length }} line(s)</span>
            </div>
          </div>
          <div class="tax-lines-preview">
            {% for line in profile.lines %}
            <div class="tax-line">
              <span class="line-name">{{ line.name }}</span>
              <span class="line-value">
                {% if line.type == 'PERCENT' %}
                  {{ line.value }}%
                {% else %}
                  {{ line.value }} MVR
                {% endif %}
                ({{ line.applies_to }})
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
          <h6>No Tax Profiles</h6>
          <p class="text-muted">Create your first tax profile to start calculating taxes automatically</p>
          <button type="button" class="btn btn-primary" onclick="showCreateProfileModal()">
            <i class="fas fa-plus me-2"></i>Create First Profile
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Create/Edit Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalTitle">Create Tax Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="profileForm">
          <input type="hidden" id="profileId" name="profile_id">
          <input type="hidden" id="profileAction" name="action" value="create">
          
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="profileName" class="form-label">Profile Name</label>
                <input type="text" class="form-control" id="profileName" name="name" required>
                <div class="form-text">e.g., "Domestic VAT", "International Tax"</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="roundingRule" class="form-label">Rounding Rule</label>
                <select class="form-select" id="roundingRule" name="rounding_rule" required>
                  <option value="ROUND_NEAREST">Round to Nearest</option>
                  <option value="ROUND_UP">Round Up</option>
                  <option value="ROUND_DOWN">Round Down</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="form-group mt-3">
            <label class="form-label">Tax Lines</label>
            <div id="taxLinesContainer">
              <!-- Tax lines will be added here -->
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addTaxLine()">
              <i class="fas fa-plus me-1"></i>Add Tax Line
            </button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
      </div>
    </div>
  </div>
</div>

<!-- Tax Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tax Calculation Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="previewAmount" class="form-label">Test Amount (MVR)</label>
          <input type="number" class="form-control" id="previewAmount" 
                 placeholder="100.00" step="0.01" min="0" onchange="calculateTaxPreview()">
        </div>
        <div class="preview-results mt-3" id="previewResults">
          <!-- Preview results will be shown here -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.profiles-container {
  padding: 20px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.profile-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.profile-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.profile-name {
  margin: 0;
  color: #2c3e50;
}

.profile-actions {
  display: flex;
  gap: 8px;
}

.edit-btn, .delete-btn {
  background: none;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
}

.edit-btn:hover {
  background: #e3f2fd;
  color: #1976d2;
}

.delete-btn:hover {
  background: #ffebee;
  color: #d32f2f;
}

.profile-details {
  margin-bottom: 12px;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
  font-size: 14px;
}

.label {
  color: #666;
}

.value {
  font-weight: 500;
}

.tax-lines-preview {
  border-top: 1px solid #eee;
  padding-top: 12px;
}

.tax-line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  font-size: 14px;
}

.line-name {
  color: #666;
}

.line-value {
  font-weight: 500;
  color: #2c3e50;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #666;
}

.empty-state h6 {
  margin: 16px 0 8px 0;
  color: #2c3e50;
}

.empty-state p {
  margin-bottom: 20px;
}

.add-btn {
  background: #4caf50;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.add-btn:hover {
  background: #45a049;
}

.tax-line-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 12px;
}

.tax-line-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.remove-line-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
}

.remove-line-btn:hover {
  background: #c82333;
}

.preview-results {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 16px;
}

.result-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  padding: 4px 0;
}

.result-item.total {
  border-top: 1px solid #dee2e6;
  padding-top: 8px;
  margin-top: 8px;
  font-weight: 600;
  font-size: 16px;
}
</style>

<script>
let currentProfile = null;

function showCreateProfileModal() {
  currentProfile = null;
  document.getElementById('profileModalTitle').textContent = 'Create Tax Profile';
  document.getElementById('profileAction').value = 'create';
  document.getElementById('profileForm').reset();
  document.getElementById('taxLinesContainer').innerHTML = '';
  addTaxLine(); // Add one default line
  new bootstrap.Modal(document.getElementById('profileModal')).show();
}

function editProfile(profileId) {
  // Fetch profile data and populate form
  fetch(`/api/tax-profiles/${profileId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        currentProfile = data.tax_profile;
        document.getElementById('profileModalTitle').textContent = 'Edit Tax Profile';
        document.getElementById('profileAction').value = 'update';
        document.getElementById('profileId').value = profileId;
        document.getElementById('profileName').value = currentProfile.name;
        document.getElementById('roundingRule').value = currentProfile.rounding_rule;
        
        // Clear and populate tax lines
        document.getElementById('taxLinesContainer').innerHTML = '';
        currentProfile.lines.forEach(line => addTaxLine(line));
        
        new bootstrap.Modal(document.getElementById('profileModal')).show();
      }
    });
}

function addTaxLine(existingLine = null) {
  const container = document.getElementById('taxLinesContainer');
  const lineId = Date.now();
  
  const lineHtml = `
    <div class="tax-line-item" data-line-id="${lineId}">
      <div class="tax-line-header">
        <h6>Tax Line</h6>
        <button type="button" class="remove-line-btn" onclick="removeTaxLine(${lineId})">
          <i class="fas fa-trash"></i>
        </button>
      </div>
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" name="line_name_${lineId}" 
                   value="${existingLine ? existingLine.name : ''}" required>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Type</label>
            <select class="form-select" name="line_type_${lineId}" onchange="toggleValueField(${lineId})">
              <option value="PERCENT" ${existingLine && existingLine.type === 'PERCENT' ? 'selected' : ''}>Percentage</option>
              <option value="FIXED" ${existingLine && existingLine.type === 'FIXED' ? 'selected' : ''}>Fixed Amount</option>
            </select>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Value</label>
            <input type="number" class="form-control" name="line_value_${lineId}" 
                   value="${existingLine ? existingLine.value : ''}" step="0.01" min="0" required>
            <div class="form-text" id="valueHelp_${lineId}">
              ${existingLine && existingLine.type === 'PERCENT' ? 'Percentage (e.g., 8.5)' : 'Amount in MVR'}
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label class="form-label">Applies To</label>
            <select class="form-select" name="line_applies_to_${lineId}">
              <option value="FARE" ${existingLine && existingLine.applies_to === 'FARE' ? 'selected' : ''}>Fare</option>
              <option value="TOTAL" ${existingLine && existingLine.applies_to === 'TOTAL' ? 'selected' : ''}>Total</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', lineHtml);
  toggleValueField(lineId);
}

function removeTaxLine(lineId) {
  const lineElement = document.querySelector(`[data-line-id="${lineId}"]`);
  if (lineElement) {
    lineElement.remove();
  }
}

function toggleValueField(lineId) {
  const typeSelect = document.querySelector(`[name="line_type_${lineId}"]`);
  const valueInput = document.querySelector(`[name="line_value_${lineId}"]`);
  const valueHelp = document.getElementById(`valueHelp_${lineId}`);
  
  if (typeSelect.value === 'PERCENT') {
    valueInput.max = '100';
    valueInput.placeholder = '0.00';
    valueHelp.textContent = 'Percentage (e.g., 8.5)';
  } else {
    valueInput.max = '';
    valueInput.placeholder = '0.00';
    valueHelp.textContent = 'Amount in MVR';
  }
}

function saveProfile() {
  const form = document.getElementById('profileForm');
  const formData = new FormData(form);
  
  // Collect tax lines data
  const taxLines = [];
  const lineElements = document.querySelectorAll('[data-line-id]');
  
  lineElements.forEach(element => {
    const lineId = element.dataset.lineId;
    const name = element.querySelector(`[name="line_name_${lineId}"]`).value;
    const type = element.querySelector(`[name="line_type_${lineId}"]`).value;
    const value = parseFloat(element.querySelector(`[name="line_value_${lineId}"]`).value);
    const appliesTo = element.querySelector(`[name="line_applies_to_${lineId}"]`).value;
    
    if (name && !isNaN(value)) {
      taxLines.push({
        name: name.trim(),
        type: type,
        value: value,
        applies_to: appliesTo,
        active: true
      });
    }
  });
  
  if (taxLines.length === 0) {
    alert('Please add at least one tax line');
    return;
  }
  
  const profileData = {
    action: formData.get('action'),
    name: formData.get('name').trim(),
    rounding_rule: formData.get('rounding_rule'),
    lines: taxLines
  };
  
  if (formData.get('action') === 'update') {
    profileData.id = parseInt(formData.get('profile_id'));
  }
  
  // Send to backend
  fetch('/owner/settings/tax-configurations', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(profileData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
      location.reload(); // Refresh to show updated data
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to save profile');
  });
}

function deleteProfile(profileId) {
  if (confirm('Are you sure you want to delete this tax profile? This action cannot be undone.')) {
    fetch('/owner/settings/tax-configurations', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'delete',
        id: profileId
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to delete profile');
    });
  }
}

function calculateTaxPreview() {
  const amount = parseFloat(document.getElementById('previewAmount').value);
  if (isNaN(amount) || amount <= 0) {
    document.getElementById('previewResults').innerHTML = '<p class="text-muted">Enter a valid amount to see preview</p>';
    return;
  }
  
  // For now, show a simple preview - in real implementation, this would call the backend
  const taxAmount = amount * 0.08; // Example 8% tax
  const total = amount + taxAmount;
  
  document.getElementById('previewResults').innerHTML = `
    <div class="result-item">
      <span>Subtotal:</span>
      <span>${amount.toFixed(2)} MVR</span>
    </div>
    <div class="result-item">
      <span>Tax Amount:</span>
      <span>${taxAmount.toFixed(2)} MVR</span>
    </div>
    <div class="result-item total">
      <span>Total:</span>
      <span>${total.toFixed(2)} MVR</span>
    </div>
  `;
}
</script>
{% endblock %} 