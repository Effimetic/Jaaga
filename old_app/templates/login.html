{% extends "base.html" %}

{% block title %}Login - Nashath Booking{% endblock %}

{% block content %}
<div class="d-flex justify-content-center align-items-center min-vh-100 pt-4 pt-md-0">
  <div class="card shadow-sm w-100" style="max-width: 400px;">
    <div class="card-body p-4">
      <div class="text-center mb-4">
        <i class="fas fa-ship fa-3x text-primary mb-3"></i>
        <h2 class="fw-bold">Welcome Back</h2>
        <p class="text-muted small">Enter your phone number to receive a login token</p>
      </div>

      <!-- Login Form -->
      <form id="loginForm" onsubmit="return false;">
        <div class="mb-3">
          <label for="phone" class="form-label">Phone Number</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-phone"></i></span>
            <input type="tel" class="form-control" id="phone" name="phone" placeholder="+960 123 4567" required>
          </div>
          <div class="form-text">You'll receive a 6-digit login token via SMS</div>
        </div>

        <button type="button" class="btn btn-primary w-100 mb-3" id="sendTokenBtn">
          <i class="fas fa-paper-plane me-2"></i>Send Login Token
        </button>
      </form>

      <!-- Token Form -->
      <div id="tokenForm" style="display: none;">
        <hr class="my-4">
        <div class="mb-3">
          <label for="token" class="form-label">Enter 6-Digit Token</label>
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-key"></i></span>
            <input type="text" class="form-control" id="token" name="token" placeholder="123456" maxlength="6" pattern="[0-9]{6}" required>
          </div>
          <div class="form-text">Enter the token you received via SMS</div>
        </div>

        <button type="button" class="btn btn-success w-100 mb-2" id="verifyTokenBtn">
          <i class="fas fa-check me-2"></i>Verify Token
        </button>

        <button type="button" class="btn btn-outline-secondary w-100" id="resendTokenBtn">
          <i class="fas fa-redo me-2"></i>Resend Token
        </button>
      </div>

      <hr class="my-4">

      <p class="text-center small mb-0">
        Don't have an account?
        <a href="{{ url_for('main.register') }}" class="text-decoration-none">Register here</a>
      </p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPhone = '';

document.getElementById('sendTokenBtn').addEventListener('click', async function () {
  const phone = document.getElementById('phone').value.trim();
  const button = this;
  const originalText = button.innerHTML;

  if (!phone) return showAlert('Please enter a phone number', 'danger');

  showLoading(button);

  try {
    const response = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone })
    });

    const data = await response.json();

    if (response.ok) {
      currentPhone = phone;
      document.getElementById('tokenForm').style.display = 'block';
      document.getElementById('loginForm').style.display = 'none';
      showAlert(data.message, 'success');
      document.getElementById('token').focus();
    } else {
      showAlert(data.error || 'Failed to send token', 'danger');
    }
  } catch (error) {
    showAlert('Network error. Please try again.', 'danger');
  } finally {
    hideLoading(button, originalText);
  }
});

document.getElementById('verifyTokenBtn').addEventListener('click', async function () {
  const token = document.getElementById('token').value.trim();
  const button = this;
  const originalText = button.innerHTML;

  if (!token || token.length !== 6) return showAlert('Please enter a valid 6-digit token', 'danger');

  showLoading(button);

  try {
    const response = await fetch('/verify_token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: currentPhone, token })
    });

    const data = await response.json();

    if (response.ok) {
      showAlert(data.message, 'success');
      setTimeout(() => window.location.href = data.redirect, 1500);
    } else {
      showAlert(data.error || 'Invalid token', 'danger');
    }
  } catch (error) {
    showAlert('Network error. Please try again.', 'danger');
  } finally {
    hideLoading(button, originalText);
  }
});

document.getElementById('resendTokenBtn').addEventListener('click', async function () {
  const button = this;
  const originalText = button.innerHTML;

  showLoading(button);

  try {
    const response = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone: currentPhone })
    });

    const data = await response.json();

    if (response.ok) {
      showAlert('New token sent to your phone', 'success');
      document.getElementById('token').value = '';
      document.getElementById('token').focus();
    } else {
      showAlert(data.error || 'Failed to resend token', 'danger');
    }
  } catch (error) {
    showAlert('Network error. Please try again.', 'danger');
  } finally {
    hideLoading(button, originalText);
  }
});

document.getElementById('phone').addEventListener('input', function (e) {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length > 0) {
    if (value.startsWith('960')) {
      value = '+960 ' + value.substring(3);
    } else if (value.startsWith('0')) {
      value = '+960 ' + value.substring(1);
    } else {
      value = '+960 ' + value;
    }
  }
  e.target.value = value;
});

document.getElementById('token').addEventListener('input', function (e) {
  e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
});
</script>
{% endblock %}
