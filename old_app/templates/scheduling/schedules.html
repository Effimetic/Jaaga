{% extends "base.html" %}

{% block title %}My Schedules - Nashath Booking{% endblock %}

{% block content %}
<!-- Mobile App Style Schedules Page -->
<div class="mobile-app-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h4 class="page-title"><i class="fas fa-calendar-alt me-2"></i>My Schedules</h4>
      <p class="page-subtitle">Manage all your upcoming trips</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearSession()" title="Clear session data">
        <i class="fas fa-broom"></i>
      </button>
      <a href="{{ url_for('scheduling.create_schedule') }}" class="add-btn" title="Create new schedule">
        <i class="fas fa-plus"></i>
      </a>
    </div>
            </div>
            
  <!-- Stats Summary -->
  <div class="stats-summary">
    <div class="stat-item">
      <div class="stat-number">{{ total_count if total_count is defined else schedules|length }}</div>
      <div class="stat-label">Total</div>
                                </div>
    <div class="stat-item">
      <div class="stat-number">{{ active_count if active_count is defined else (schedules|selectattr('status', 'equalto', 'active')|list|length) }}</div>
      <div class="stat-label">Active</div>
                            </div>
    <div class="stat-item">
      <div class="stat-number">{{ completed_count if completed_count is defined else (schedules|selectattr('status', 'equalto', 'completed')|list|length) }}</div>
      <div class="stat-label">Completed</div>
                                    </div>
                                </div>
                                
  <!-- Filters -->
  <div class="filters">
    <div class="date-row">
      <div class="date-field">
        <label for="startDate">From</label>
        <input type="date" id="startDate" class="form-input" title="Filter start date">
      </div>
      <div class="date-field">
        <label for="endDate">To</label>
        <input type="date" id="endDate" class="form-input" title="Filter end date">
      </div>
                                        </div>
    <div class="filter-actions">
      <button class="filter-btn primary" id="applyFilters" type="button" title="Apply date filters"><i class="fas fa-filter me-2"></i>Apply</button>
      <button class="filter-btn" id="clearFilters" type="button" title="Clear filters">Clear</button>
                                    </div>
                                </div>
                                
  <!-- Empty State Template (client-rendered) -->
  <template id="emptyStateTpl">
    <div class="empty-state">
      <div class="empty-icon"><i class="far fa-calendar-times"></i></div>
      <h5 class="empty-title">No Schedules Found</h5>
      <p class="empty-description">Try adjusting your date filters or create a new schedule.</p>
      <a href="{{ url_for('scheduling.create_schedule') }}" class="empty-action-btn" title="Create your first schedule">
        <i class="fas fa-plus me-2"></i>Create Schedule
      </a>
    </div>
  </template>

  <!-- Planner List & Load More (client-rendered) -->
  <div id="schedulesList" class="planner-list" aria-live="polite"></div>
  <div id="loadMoreContainer" class="load-more-container" style="display:none;">
    <button id="loadMoreBtn" class="empty-action-btn" type="button" title="Load earlier schedules">
      <i class="fas fa-clock-rotate-left me-2"></i>Load earlier schedules
                                    </button>
                                </div>

  <!-- Options Modal -->
  <div class="modal fade" id="optionsModal" tabindex="-1" aria-labelledby="optionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="optionsModalLabel">Schedule options</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
        <div class="modal-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <div class="fw-semibold" id="modalScheduleName">—</div>
              <div class="text-muted small" id="modalScheduleMeta">—</div>
                        </div>
                    </div>
          <div class="list-group">
            <a id="modalViewBtn" href="#" class="list-group-item list-group-item-action"><i class="fas fa-eye me-2"></i>View</a>
            <a id="modalEditBtn" href="#" class="list-group-item list-group-item-action"><i class="fas fa-edit me-2"></i>Edit</a>
            <button id="modalDeleteBtn" type="button" class="list-group-item list-group-item-action text-danger"><i class="fas fa-trash me-2"></i>Delete</button>
                </div>
                </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let page = 1;
let hasMore = true;
let optionsModal;
let selectedSchedule = null;

function formatDayHeading(dateStr) {
  const d = new Date(dateStr);
  const opts = { weekday: 'short', day: 'numeric', month: 'short' };
  return d.toLocaleDateString(undefined, opts);
}

function getPrimaryTime(item) {
  if (!item.destinations || !item.destinations.length) return '—';
  const times = item.destinations
    .map(d => d.departure_time)
    .filter(Boolean)
    .sort();
  return times.length ? times[0] : '—';
}

function ensureDaySection(dateStr) {
  const list = document.getElementById('schedulesList');
  const sectionId = `day-${dateStr}`;
  let day = document.getElementById(sectionId);
  if (!day) {
    day = document.createElement('section');
    day.className = 'planner-day';
    day.id = sectionId;
    day.innerHTML = `
      <div class="day-header">${formatDayHeading(dateStr)}</div>
      <div class="day-items"></div>
    `;
    list.appendChild(day);
  }
  return day.querySelector('.day-items');
}

function createPlannerRow(item) {
  const time = getPrimaryTime(item);
  const row = document.createElement('div');
  row.className = 'planner-row';
  row.innerHTML = `
    <div class="row-time" aria-label="Departure time">${time}</div>
    <div class="row-title" title="${item.name}">
      <div class="row-name">${item.name}</div>
      <div class="row-sub">${item.boat_name} • ${item.available_seats}/${item.total_seats} seats</div>
    </div>
    <div class="row-actions">
      <button class="dots-btn" type="button" onclick="openOptions(${item.id}, '${item.name.replace(/'/g, "\\'")}', '${item.boat_name.replace(/'/g, "\\'")}', '${item.date_display}')" title="More options" aria-label="More options">
        <i class="fas fa-ellipsis-vertical"></i>
      </button>
    </div>
  `;
  return row;
}

async function loadSchedules(reset=false) {
  const list = document.getElementById('schedulesList');
  const loadMoreContainer = document.getElementById('loadMoreContainer');
  const startDate = document.getElementById('startDate') ? document.getElementById('startDate').value : '';
  const endDate = document.getElementById('endDate') ? document.getElementById('endDate').value : '';
  
  if (reset) { page = 1; hasMore = true; list.innerHTML = ''; }
  if (!hasMore) return;

  const params = new URLSearchParams({ page: String(page), per_page: '10' });
  if (startDate) params.append('start_date', startDate);
  if (endDate) params.append('end_date', endDate);

  const res = await fetch(`/schedules/list?${params.toString()}`);
  const data = await res.json();
  if (!res.ok) { showAlert(data.error || 'Failed to load schedules', 'danger'); return; }

  if (data.items.length === 0 && page === 1) {
    const tpl = document.getElementById('emptyStateTpl');
    if (tpl) {
      list.appendChild(tpl.content.cloneNode(true));
    } else {
      list.innerHTML = '<p class="text-muted">No schedules found.</p>';
    }
  } else {
    // Sort by time within the day for consistent ordering
    const items = data.items.slice();
    items.sort((a, b) => {
      if (a.date !== b.date) return a.date.localeCompare(b.date);
      const ta = getPrimaryTime(a) || '99:99';
      const tb = getPrimaryTime(b) || '99:99';
      return ta.localeCompare(tb);
    });
    items.forEach(item => {
      const container = ensureDaySection(item.date);
      container.appendChild(createPlannerRow(item));
    });
  }

  hasMore = data.has_more;
  loadMoreContainer.style.display = hasMore ? 'block' : 'none';
  page += 1;
}

document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('optionsModal');
  optionsModal = new bootstrap.Modal(modalEl);
  const applyBtn = document.getElementById('applyFilters');
  const clearBtn = document.getElementById('clearFilters');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  if (applyBtn) applyBtn.addEventListener('click', () => loadSchedules(true));
  if (clearBtn) clearBtn.addEventListener('click', () => {
    const s = document.getElementById('startDate');
    const e = document.getElementById('endDate');
    if (s) s.value = '';
    if (e) e.value = '';
    loadSchedules(true);
  });
  if (loadMoreBtn) loadMoreBtn.addEventListener('click', () => loadSchedules(false));
  loadSchedules(true);
});

function openOptions(id, name, boatName, dateDisplay) {
  selectedSchedule = { id, name };
  // Fill modal info
  document.getElementById('modalScheduleName').textContent = name;
  document.getElementById('modalScheduleMeta').textContent = `${boatName} • ${dateDisplay}`;
  // Wire buttons
  const viewBtn = document.getElementById('modalViewBtn');
  const editBtn = document.getElementById('modalEditBtn');
  const deleteBtn = document.getElementById('modalDeleteBtn');
  viewBtn.href = `/schedules/${id}`;
  editBtn.href = `/schedules/${id}/edit`;
  deleteBtn.onclick = () => { optionsModal.hide(); deleteSchedule(id, name); };
  optionsModal.show();
}

function deleteSchedule(scheduleId, scheduleName) {
  if (confirm('Are you sure you want to delete the schedule "' + scheduleName + '"?')) {
    fetch('/schedules/' + scheduleId + '/delete', {
            method: 'POST',
      headers: { 'Content-Type': 'application/json' }
        })
    .then(r => r.json())
        .then(data => {
            if (data.message) {
                showAlert(data.message, 'success');
        setTimeout(() => window.location.reload(), 1200);
            } else {
                showAlert(data.error || 'Failed to delete schedule', 'danger');
            }
        })
    .catch(() => showAlert('Network error. Please try again.', 'danger'));
    }
}
</script>

<style>
  .mobile-app-container { max-width: 600px; margin: 0 auto; padding: 1rem; }

  .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding: 1rem; background: #fff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e9ecef; }
  .header-content { flex: 1; }
  .page-title { margin: 0; font-size: 1.25rem; font-weight: 600; color: #212529; }
  .page-subtitle { margin: 0.25rem 0 0 0; font-size: 0.875rem; color: #6c757d; }
  .add-btn { width: 45px; height: 45px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #fff; text-decoration: none; font-size: 1.125rem; transition: transform 0.2s ease; }
  .add-btn:hover { transform: scale(1.05); color: #fff; text-decoration: none; }

  .stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
  .stat-item { background: #fff; border-radius: 12px; padding: 1rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e9ecef; }
  .stat-number { font-size: 1.4rem; font-weight: 700; color: #212529; line-height: 1; }
  .stat-label { font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem; font-weight: 500; }

  /* Filters */
  .filters { background: #fff; border: 1px solid #e9ecef; border-radius: 16px; padding: 1rem; margin-bottom: 1rem; }
  .date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
  .date-field label { font-size: 0.85rem; color: #6c757d; margin-bottom: 0.25rem; display: block; }
  .form-input { width: 100%; border: 1px solid #e9ecef; border-radius: 10px; padding: 0.55rem 0.75rem; background: #fff; color: #212529; }
  .filter-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
  .filter-btn { border: 1px solid #e9ecef; background: #f8f9fa; color: #495057; padding: 0.55rem 0.9rem; border-radius: 10px; font-weight: 500; }
  .filter-btn:hover { background: #e9ecef; }
  .filter-btn.primary { background: #0d6efd; border-color: #0d6efd; color: #fff; }
  .filter-btn.primary:hover { background: #0b5ed7; }

  .load-more-container { text-align: center; margin-top: 1rem; }

  .schedules-list { display: flex; flex-direction: column; gap: 1rem; }
  .schedule-card { background: #fff; border-radius: 16px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e9ecef; transition: transform 0.2s ease; }
  .schedule-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }

  .schedule-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.75rem; }
  .schedule-info { flex: 1; }
  .schedule-name { margin: 0 0 0.5rem 0; font-size: 1.05rem; font-weight: 600; color: #212529; }
  .schedule-meta { display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.9rem; color: #6c757d; }
  .schedule-meta .fa-calendar, .schedule-meta .fa-ship { color: #667eea; }
  .schedule-status { margin-left: 1rem; }
  .status-badge { padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
  .status-badge.active { background: #d1e7dd; color: #0f5132; }
  .status-badge.completed { background: #e2e3e5; color: #41464b; }
  .status-badge.cancelled { background: #f8d7da; color: #842029; }

  .schedule-stats { display: flex; align-items: center; gap: 0.75rem; margin: 0.5rem 0 0.75rem 0; color: #495057; }
  .schedule-stats .seats { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.9rem; }
  .schedule-stats .seats i { color: #198754; }

  .destinations { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem; }
  .destination-chip { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.6rem; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 999px; font-size: 0.8rem; color: #495057; }
  .destination-chip i { color: #667eea; }
  .destination-chip small { color: #6c757d; margin-left: 0.25rem; }

  .schedule-actions { display: flex; gap: 0.5rem; }
  .action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.7rem; border-radius: 10px; text-decoration: none; font-size: 0.875rem; font-weight: 500; border: none; cursor: pointer; transition: all 0.2s ease; }
  .action-btn.primary { background: #e7f3ff; color: #0d6efd; }
  .action-btn.primary:hover { background: #d1e7ff; color: #0d6efd; text-decoration: none; }
  .action-btn.secondary { background: #f8f9fa; color: #6c757d; }
  .action-btn.secondary:hover { background: #e9ecef; color: #6c757d; text-decoration: none; }
  .action-btn.danger { background: #f8d7da; color: #dc3545; }
  .action-btn.danger:hover { background: #f1aeb5; color: #dc3545; }

  .empty-state { text-align: center; padding: 3rem 1rem; }
  .empty-icon { font-size: 4rem; color: #dee2e6; margin-bottom: 1rem; }
  .empty-title { margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: #495057; }
  .empty-description { margin: 0 0 1.5rem 0; color: #6c757d; font-size: 0.9rem; line-height: 1.5; }
  .empty-action-btn { display: inline-flex; align-items: center; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; text-decoration: none; border-radius: 12px; font-weight: 500; transition: transform 0.2s ease; }
  .empty-action-btn:hover { transform: translateY(-2px); color: #fff; text-decoration: none; }

  /* Planner styles */
  .planner-list { display: flex; flex-direction: column; gap: 1rem; }
  .planner-day { background: #fff; border: 1px solid #e9ecef; border-radius: 16px; overflow: hidden; }
  .planner-day .day-header { background: #f8f9fa; color: #495057; padding: 0.6rem 1rem; font-weight: 600; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1; }
  .planner-day .day-items { display: flex; flex-direction: column; }
  .planner-row { display: grid; grid-template-columns: 64px 1fr auto; gap: 0.75rem; align-items: center; padding: 0.6rem 1rem; border-bottom: 1px solid #f1f3f5; }
  .planner-row:last-child { border-bottom: none; }
  .row-time { font-weight: 700; color: #212529; font-variant-numeric: tabular-nums; }
  .row-title { display: flex; flex-direction: column; }
  .row-name { font-weight: 600; color: #212529; }
  .row-sub { font-size: 0.85rem; color: #6c757d; }
  .row-actions .dots-btn { border: none; background: transparent; color: #6c757d; padding: 0.25rem 0.5rem; border-radius: 6px; }
  .row-actions .dots-btn:hover { background: #f1f3f5; color: #212529; }
  .row-actions .dropdown-toggle::after { display: none; }
  .row-actions { position: relative; }
  .row-actions .dropdown-menu { min-width: 180px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); border: 1px solid #e9ecef; z-index: 1080; margin-top: 6px; }

  @media (min-width: 768px) {
    .mobile-app-container { max-width: 800px; }
    .schedule-meta { flex-direction: row; gap: 1rem; }
  }

  @media (max-width: 480px) {
    .stats-summary { grid-template-columns: 1fr; gap: 0.5rem; }
    .date-row { grid-template-columns: 1fr; }
    .planner-row { grid-template-columns: 52px 1fr auto; }
    .row-time { font-size: 0.95rem; }
    .row-name { font-size: 0.95rem; }
    .row-sub { font-size: 0.8rem; }
}

.header-actions {
  display: flex;
  align-items: center;
}

.header-actions .btn {
  border-radius: 8px;
  font-size: 0.875rem;
  padding: 0.5rem 0.75rem;
}
</style>

<script>
// Function to clear session data
async function clearSession() {
  try {
    const response = await fetch('/schedules/clear-session', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const data = await response.json();
    if (response.ok) {
      alert('Session cleared successfully! You can now create a new schedule.');
      // Optionally redirect to create schedule
      window.location.href = '/schedules/create';
    } else {
      alert('Failed to clear session: ' + data.error);
    }
  } catch (error) {
    alert('Error clearing session: ' + error.message);
  }
}
</script>
{% endblock %} 