{% extends "base.html" %}

{% block title %}Book Tickets{% endblock %}

{% block content %}
<div class="mobile-app-container">
  <div class="page-header">
    <div class="header-content">
      <h4 class="page-title"><i class="fas fa-ticket-alt me-2"></i>Book Tickets</h4>
      <p class="page-subtitle">{{ schedule.name }} • {{ schedule.schedule_date.strftime('%B %d, %Y') }}</p>
    </div>
    <a href="{{ url_for('scheduling.view_schedule', schedule_id=schedule.id) }}" class="add-btn" title="Back to schedule">
      <i class="fas fa-arrow-left"></i>
    </a>
  </div>

  <!-- Schedule Summary -->
  <div class="schedule-summary">
    <div class="summary-header">
      <h6><i class="fas fa-info-circle me-2"></i>Schedule Details</h6>
    </div>
    <div class="summary-content">
      <div class="summary-row">
        <span class="label">Boat:</span>
        <span class="value">{{ schedule.boat.name }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Available Seats:</span>
        <span class="value">{{ schedule.available_seats }} / {{ schedule.total_seats }}</span>
      </div>
      <div class="summary-row">
        <span class="label">Route:</span>
        <span class="value">
          {% for dest in schedule.destinations %}
            {{ dest.island_name }}{% if not loop.last %} → {% endif %}
          {% endfor %}
        </span>
      </div>
    </div>
  </div>

  <!-- Booking Form -->
  <div class="booking-form">
    <form id="unifiedBookingForm">
      <!-- Channel Selection -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="fas fa-users me-2"></i>Booking Channel
        </h6>
        <div class="channel-selection">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="channel" id="channelPublic" value="PUBLIC" checked>
            <label class="form-check-label" for="channelPublic">
              <i class="fas fa-globe me-2"></i>Public Booking
            </label>
          </div>
          {% if current_user.role == 'owner' %}
          <div class="form-check">
            <input class="form-check-input" type="radio" name="channel" id="channelAgent" value="AGENT">
            <label class="form-check-label" for="channelAgent">
              <i class="fas fa-user-tie me-2"></i>Agent Booking
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="channel" id="channelOwner" value="OWNER">
            <label class="form-check-label" for="channelOwner">
              <i class="fas fa-crown me-2"></i>Owner Booking
            </label>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Agent Selection (if agent channel) -->
      <div class="form-section" id="agentSelection" style="display: none;">
        <h6 class="section-title">
          <i class="fas fa-user-tie me-2"></i>Select Agent
        </h6>
        <select class="form-select" id="agentSelect" name="agent_id">
          <option value="">Choose an agent...</option>
          <!-- Agents will be loaded dynamically -->
        </select>
      </div>

      <!-- Ticket Selection -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="fas fa-ticket-alt me-2"></i>Select Tickets
        </h6>
        <div id="ticketTypesContainer">
          <div class="text-center py-3">
            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">Loading available ticket types...</p>
          </div>
        </div>
      </div>

      <!-- Passenger Details -->
      <div class="form-section" id="passengerDetails" style="display: none;">
        <h6 class="section-title">
          <i class="fas fa-user me-2"></i>Passenger Information
        </h6>
        <div id="passengerForms">
          <!-- Passenger forms will be generated dynamically -->
        </div>
      </div>

      <!-- Seat Selection (if enabled) -->
      <div class="form-section" id="seatSelection" style="display: none;">
        <h6 class="section-title">
          <i class="fas fa-chair me-2"></i>Seat Selection
        </h6>
        <div class="seat-map-container">
          <div id="seatMap">
            <!-- Seat map will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Pricing Summary -->
      <div class="form-section" id="pricingSummary" style="display: none;">
        <h6 class="section-title">
          <i class="fas fa-calculator me-2"></i>Pricing Summary
        </h6>
        <div class="pricing-breakdown">
          <div class="price-row">
            <span class="label">Subtotal:</span>
            <span class="value" id="subtotal">MVR 0.00</span>
          </div>
          <div class="price-row" id="taxRow" style="display: none;">
            <span class="label">Taxes:</span>
            <span class="value" id="taxTotal">MVR 0.00</span>
          </div>
          <div class="price-row" id="discountRow" style="display: none;">
            <span class="label">Discounts:</span>
            <span class="value" id="discountTotal">MVR 0.00</span>
          </div>
          <div class="price-row total">
            <span class="label">Total:</span>
            <span class="value" id="grandTotal">MVR 0.00</span>
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="fas fa-address-book me-2"></i>Contact Information
        </h6>
        <div class="row">
          <div class="col-md-6">
            <label for="buyerName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="buyerName" name="buyer_name" required>
          </div>
          <div class="col-md-6">
            <label for="buyerPhone" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="buyerPhone" name="buyer_phone" required>
          </div>
        </div>
        <div class="mt-3">
          <label for="buyerNationalId" class="form-label">National ID (Optional)</label>
          <input type="text" class="form-control" id="buyerNationalId" name="buyer_national_id">
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button type="submit" class="submit-btn" id="submitBtn" disabled>
          <i class="fas fa-credit-card me-2"></i>Proceed to Payment
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .mobile-app-container { max-width: 800px; margin: 0 auto; padding: 1rem; }
  
  .page-header { 
    display: flex; align-items: center; justify-content: space-between; 
    margin-bottom: 1rem; padding: 1rem; background: #fff; 
    border: 1px solid #e9ecef; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); 
  }
  
  .header-content { flex: 1; }
  .page-title { margin: 0; font-size: 1.125rem; font-weight: 600; color: #212529; }
  .page-subtitle { margin: 0.25rem 0 0; color: #6c757d; font-size: 0.85rem; }
  
  .add-btn { 
    width: 40px; height: 40px; background: #f1f3f5; color: #495057; 
    display: inline-flex; align-items: center; justify-content: center; 
    border-radius: 10px; text-decoration: none; 
  }
  
  .schedule-summary {
    background: #fff; border: 1px solid #e9ecef; border-radius: 16px; 
    padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .summary-header h6 { margin: 0; color: #495057; font-weight: 600; }
  .summary-content { margin-top: 1rem; }
  .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
  .summary-row .label { font-weight: 500; color: #6c757d; }
  .summary-row .value { color: #212529; }
  
  .booking-form {
    background: #fff; border: 1px solid #e9ecef; border-radius: 16px; 
    padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  .form-section { margin-bottom: 2rem; }
  .section-title { font-size: 1rem; font-weight: 600; color: #495057; margin-bottom: 1rem; }
  
  .channel-selection { display: flex; flex-direction: column; gap: 0.75rem; }
  .form-check { display: flex; align-items: center; }
  .form-check-input { margin-right: 0.75rem; }
  .form-check-label { font-weight: 500; cursor: pointer; }
  
  .ticket-type-card {
    background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; 
    padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s ease;
  }
  
  .ticket-type-card:hover { border-color: #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .ticket-type-card.selected { border-color: #667eea; background: #e3f2fd; }
  
  .ticket-type-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;
  }
  
  .ticket-type-name { font-weight: 600; color: #212529; }
  .ticket-type-code { 
    background: #e9ecef; color: #6c757d; padding: 0.25rem 0.5rem; 
    border-radius: 6px; font-size: 0.85rem; font-family: monospace;
  }
  
  .ticket-type-price { font-size: 1.1rem; font-weight: 600; color: #28a745; }
  
  .quantity-controls {
    display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;
  }
  
  .quantity-btn {
    width: 32px; height: 32px; border: 1px solid #dee2e6; background: #fff;
    border-radius: 6px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s ease;
  }
  
  .quantity-btn:hover { background: #f8f9fa; border-color: #adb5bd; }
  .quantity-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .quantity-display {
    min-width: 40px; text-align: center; font-weight: 600; color: #495057;
  }
  
  .passenger-form {
    background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; 
    padding: 1rem; margin-bottom: 1rem;
  }
  
  .passenger-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;
  }
  
  .passenger-title { font-weight: 600; color: #495057; margin: 0; }
  .remove-passenger { 
    background: #dc3545; color: white; border: none; border-radius: 6px;
    width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 0.75rem;
  }
  
  .pricing-breakdown {
    background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 1rem;
  }
  
  .price-row {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;
  }
  
  .price-row:last-child { margin-bottom: 0; }
  .price-row.total { 
    border-top: 1px solid #dee2e6; padding-top: 0.5rem; 
    font-weight: 600; font-size: 1.1rem; color: #212529;
  }
  
  .price-row .label { color: #6c757d; }
  .price-row .value { color: #212529; font-weight: 500; }
  
  .form-actions { margin-top: 2rem; }
  .submit-btn {
    width: 100%; border: none; border-radius: 12px; padding: 1rem;
    background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; font-weight: 600;
    font-size: 1.1rem; cursor: pointer; transition: all 0.2s ease;
  }
  
  .submit-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
  .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }
</style>
{% endblock %}

{% block scripts %}
<script>
let selectedTickets = {};
let ticketTypes = [];
let scheduleData = {{ schedule|tojson }};

// Load ticket types when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadTicketTypes();
    setupChannelChange();
});

// Load available ticket types for this schedule
async function loadTicketTypes() {
    try {
        const response = await fetch(`/api/schedules/${scheduleData.id}/ticket-types`);
        const data = await response.json();
        
        if (response.ok) {
            ticketTypes = data.ticket_types;
            renderTicketTypes();
        } else {
            showAlert('Failed to load ticket types', 'danger');
        }
    } catch (error) {
        console.error('Error loading ticket types:', error);
        showAlert('Failed to load ticket types', 'danger');
    }
}

// Render ticket types as selectable cards
function renderTicketTypes() {
    const container = document.getElementById('ticketTypesContainer');
    
    if (!ticketTypes || ticketTypes.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No ticket types available for this schedule.
            </div>
        `;
        return;
    }
    
    const html = ticketTypes.map(type => `
        <div class="ticket-type-card" data-id="${type.id}">
            <div class="ticket-type-header">
                <div>
                    <div class="ticket-type-name">${type.name}</div>
                    <span class="ticket-type-code">${type.code}</span>
                </div>
                <div class="ticket-type-price">MVR ${type.base_price}</div>
            </div>
            <div class="quantity-controls">
                <button type="button" class="quantity-btn" onclick="decreaseQuantity(${type.id})" disabled>-</button>
                <span class="quantity-display" id="qty-${type.id}">0</span>
                <button type="button" class="quantity-btn" onclick="increaseQuantity(${type.id})">+</button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

// Handle quantity changes
function increaseQuantity(ticketTypeId) {
    const currentQty = selectedTickets[ticketTypeId] || 0;
    selectedTickets[ticketTypeId] = currentQty + 1;
    
    updateQuantityDisplay(ticketTypeId);
    updatePassengerForms();
    updatePricingSummary();
    updateSubmitButton();
}

function decreaseQuantity(ticketTypeId) {
    const currentQty = selectedTickets[ticketTypeId] || 0;
    if (currentQty > 0) {
        selectedTickets[ticketTypeId] = currentQty - 1;
        if (selectedTickets[ticketTypeId] === 0) {
            delete selectedTickets[ticketTypeId];
        }
        
        updateQuantityDisplay(ticketTypeId);
        updatePassengerForms();
        updatePricingSummary();
        updateSubmitButton();
    }
}

function updateQuantityDisplay(ticketTypeId) {
    const qtyDisplay = document.getElementById(`qty-${ticketTypeId}`);
    const card = qtyDisplay.closest('.ticket-type-card');
    const decreaseBtn = card.querySelector('.quantity-btn:first-child');
    
    const qty = selectedTickets[ticketTypeId] || 0;
    qtyDisplay.textContent = qty;
    
    // Update card selection state
    if (qty > 0) {
        card.classList.add('selected');
        decreaseBtn.disabled = false;
    } else {
        card.classList.remove('selected');
        decreaseBtn.disabled = true;
    }
}

// Update passenger forms based on selected tickets
function updatePassengerForms() {
    const totalPassengers = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
    const container = document.getElementById('passengerForms');
    
    if (totalPassengers === 0) {
        document.getElementById('passengerDetails').style.display = 'none';
        return;
    }
    
    document.getElementById('passengerDetails').style.display = 'block';
    
    // Generate passenger forms
    let html = '';
    let passengerIndex = 1;
    
    for (const [ticketTypeId, quantity] of Object.entries(selectedTickets)) {
        const ticketType = ticketTypes.find(t => t.id == ticketTypeId);
        
        for (let i = 0; i < quantity; i++) {
            html += `
                <div class="passenger-form">
                    <div class="passenger-header">
                        <h6 class="passenger-title">Passenger ${passengerIndex} - ${ticketType.name}</h6>
                        <button type="button" class="remove-passenger" onclick="removePassenger(${passengerIndex})" title="Remove passenger">×</button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="passengers[${passengerIndex}][name]" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" name="passengers[${passengerIndex}][phone]" required>
                        </div>
                    </div>
                    <input type="hidden" name="passengers[${passengerIndex}][ticket_type_id]" value="${ticketTypeId}">
                </div>
            `;
            passengerIndex++;
        }
    }
    
    container.innerHTML = html;
}

function removePassenger(passengerIndex) {
    // This would need more complex logic to handle ticket type distribution
    // For now, just refresh the forms
    updatePassengerForms();
}

// Update pricing summary
function updatePricingSummary() {
    const totalPassengers = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
    
    if (totalPassengers === 0) {
        document.getElementById('pricingSummary').style.display = 'none';
        return;
    }
    
    document.getElementById('pricingSummary').style.display = 'block';
    
    // Calculate subtotal
    let subtotal = 0;
    for (const [ticketTypeId, quantity] of Object.entries(selectedTickets)) {
        const ticketType = ticketTypes.find(t => t.id == ticketTypeId);
        subtotal += ticketType.base_price * quantity;
    }
    
    // For now, just show subtotal (taxes would be calculated by backend)
    document.getElementById('subtotal').textContent = `MVR ${subtotal.toFixed(2)}`;
    document.getElementById('grandTotal').textContent = `MVR ${subtotal.toFixed(2)}`;
}

// Update submit button state
function updateSubmitButton() {
    const totalPassengers = Object.values(selectedTickets).reduce((sum, qty) => sum + qty, 0);
    const submitBtn = document.getElementById('submitBtn');
    
    submitBtn.disabled = totalPassengers === 0;
}

// Handle channel change
function setupChannelChange() {
    document.querySelectorAll('input[name="channel"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const agentSelection = document.getElementById('agentSelection');
            if (this.value === 'AGENT') {
                agentSelection.style.display = 'block';
                loadAgents();
            } else {
                agentSelection.style.display = 'none';
            }
        });
    });
}

// Load agents for agent channel
async function loadAgents() {
    try {
        const response = await fetch('/api/agents');
        const data = await response.json();
        
        if (response.ok) {
            const select = document.getElementById('agentSelect');
            select.innerHTML = '<option value="">Choose an agent...</option>' +
                data.agents.map(agent => `<option value="${agent.id}">${agent.name}</option>`).join('');
        }
    } catch (error) {
        console.error('Error loading agents:', error);
    }
}

// Handle form submission
document.getElementById('unifiedBookingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Booking...';
    
    try {
        // Collect form data
        const formData = new FormData(this);
        const data = {
            channel: formData.get('channel'),
            agent_id: formData.get('agent_id') || null,
            buyer_name: formData.get('buyer_name'),
            buyer_phone: formData.get('buyer_phone'),
            buyer_national_id: formData.get('buyer_national_id') || null,
            tickets: []
        };
        
        // Add ticket requests
        for (const [ticketTypeId, quantity] of Object.entries(selectedTickets)) {
            if (quantity > 0) {
                data.tickets.push({
                    ticket_type_id: parseInt(ticketTypeId),
                    quantity: quantity
                });
            }
        }
        
        // Create booking
        const response = await fetch(`/api/schedules/${scheduleData.id}/bookings`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Booking created successfully!', 'success');
            // Redirect to payment or booking confirmation
            setTimeout(() => {
                window.location.href = `/bookings/${result.booking.id}`;
            }, 1500);
        } else {
            showAlert(result.error || 'Failed to create booking', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('An error occurred while creating the booking', 'danger');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.mobile-app-container');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
